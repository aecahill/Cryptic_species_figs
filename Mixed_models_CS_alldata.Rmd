---
title: "Mixed models for CS paper 2, all data"
output:
  word_document: default
  html_document: default
date: "2024-01-19"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
```

## GLMMs from January 2024 

I am coming back to this after several months away. I think I need to analyze each question using GLMM, with phylum_class as a random effect. I think I understand the syntax here, which is this:

summary(glmer(CSss~Eco_diff+(1|phylum_class),data=surveymorpho,family=binomial))

The probability of a species having CSss based on Eco_diff, once the variance from phylum_class is accounted for. 

So, game plan: build a model and then work through the table with it. 

First, code to load libraries, read in files, etc
```{r}


library(dplyr)
library(stringr)
library(ggplot2)
library(vioplot)
library(bestglm)
library(tidyr)
library(ggmosaic)
library(lme4)
library(cowplot)
library(GLMMselect)
library(cAIC4)
library(wesanderson)

#survey <- read.csv(file="977_CScpx_100cols_Habitat&Larva_Completed_20230928_comma.csv"   , header=TRUE ) # file ready for analyses with new variables ,# data with range sizes rarefied for 100 sites, and RIOK
survey <- read.csv(file="coma978_cryptic_cpx_96var_2023.nov.16.csv"   , header=TRUE ) #Adjusted Nov 15 2023 to fix errors in duplicated species
nomsp <-read.csv2(file="file_S2_oct.csv" ,header=T)# need to load all nominal spp data for some comparisons 
bio<-read.csv2(file="input_BIOLOGY_classes.csv")
surveylarv<-read.csv("survey_oct11.csv",header=TRUE) #This file has also been updated to include all 978 spp (ie with Eurytemora affinis)


# cleaned from some original variables and temporary variable (CAUTION: CHECK COLUMN nb!):
# reintroduce genus but several possibilities: solution below not OK for CS at genus level (no data), can also use NameBoforeCor instead of acceptedName
survey$genus <-word(survey$acceptedName_wormsV1,1)
survey$genusBC <-word(survey$NameBeforeCor,1) # see if this genusBC changes results / genus.
survey <-as.data.frame(unclass(survey),stringsAsFactors=TRUE)
survey$Geo_dif3 <-survey$Geo_diff
levels(survey$Geo_dif3)<-c("","Allopatric", "Allopatric", "Allopatric","Sympatric","Sympatric, Allopatric", "Sympatric, Allopatric", "Sympatric, Allopatric")
levels(survey$Geo_dif3)<-c(NA, "Allopatric","Sympatric","Sympatric, Allopatric")
# add booleans for geographical differentiation and morphological differentiation variables
survey$symp    <- str_detect(survey$Geo_diff,"Sympatric")
survey$sympara <- str_detect(survey$Geo_diff,"Sympatric") | str_detect(survey$Geo_diff,"Parapatric")
survey$allop   <- str_detect(survey$Geo_diff,"Allopatric")
survey$NoMorphoDiff    <- survey$Morpho_diff=="No differentiation"
survey$StatMorphoDiff  <- survey$Morpho_diff=="Statistic"
survey$DiagMorphoDiff  <- survey$Morpho_diff=="Diagnostic"
# add biological traits of the class to which the CScpx belongs
survey$phylum_class <-paste0(survey$phylum_worms,"_",survey$class_worms)
survey$hard_skeleton  <- factor(bio$hard_skeleton[match(survey$phylum_class,bio$phylum_class)])
survey$ferti          <- factor(bio$ferti[match(survey$phylum_class,bio$phylum_class)])
survey$image          <- factor(bio$image[match(survey$phylum_class,bio$phylum_class)])
survey$genitals       <- factor(bio$genitals[match(survey$phylum_class,bio$phylum_class)])
survey$CSss     <-str_detect(survey$Morpho_diff,"Statistic") | str_detect(survey$Morpho_diff,"No differentiation") #need to combine stat + no_diff to make CSss
survey$Sympatric <-str_detect(survey$Geo_dif3,"Sympatric") | str_detect(survey$Geo_dif3,"Sympatric, Allopatric") #This creates a vector that counts sym/allo as sympatric - that is, do spp exist in sympatry?
#survey$CSsl     <-str_detect(survey$Morpho_diff,"Statistic") | str_detect(survey$Morpho_diff,"Diagnostic") #

```

1) Taxonomic work is needed? Are there more CSss or CSsl overall? This can probably stay the same, chi-square test.

```{r}
expected<-c((length(na.omit(survey$Morpho_diff)))/2,(length(na.omit(survey$Morpho_diff)))/2)
observed<-c(length(which(survey$CSss=="TRUE")),length(which(survey$CSss=="FALSE")))
chisq.test(cbind(expected,observed))

# Next we will make a graph
CSssGraph<-as.data.frame(cbind(observed,c("CSss","CSsl")))
colnames(CSssGraph)<-c("Number","CS_Type")
ggplot(data=CSssGraph,aes(x=CS_Type, y=as.numeric(Number)))+geom_bar(stat="identity")+
  theme_bw()+
  #theme(legend.position="none")+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())+
  theme(axis.text.x = element_text(angle = 65,hjust=1))

```

More CSss than the 50% benchmark (significant), so reject the idea that most CS are just due to taxonomic oversight. BUT, does this vary with phyla or classes?

```{r}
surveymorpho<-filter(survey, Morpho_diff != "NA") #make matrix where only the cases where morpho was studied is here

drop1(glm(CSss~phylum_wormsV1,data=surveymorpho,family=binomial),test="Chisq")
drop1(glm(CSss~class_wormsV1,data=surveymorpho,family=binomial),test="Chisq")
drop1(glm(CSss~phylum_class,data=surveymorpho,family=binomial),test="Chisq")

```

Phylum is not significant, but class is (both class_wormsV1 and phylum_class). This is because of a few classes, mostly Ascidea (others are minor classes, ie <10 species). So, from here I will be using mixed models with phylum_class as a random factor. This will *remove variation due to phylum_class* and allow us to see if there is a main effect once phylum_class is accounted for. This is not a proper phylo correction per se but should get the job done.


2. Are there differences in time of description? For this, the independent variable is time (year of description OR decade of description; not sure why we need to bin but I will run both of them). Dependent variable is CSss.

```{r}
#Add decade to dataframe
breaks=c(1750,1760,1770,1780,1790,1800,1810,1820,1830,1840,1850,1860,1870,1880,1890,1900,1910,
         1920,1930,1940,1950,1960,1970,1980,1990,2000,2010,2020,2030)
surveymorpho$decade<-cut(as.numeric(surveymorpho$yearb),breaks=breaks)
levels(surveymorpho$decade)<-c("1760","1770","1780","1790","1800","1810","1820","1830","1840",
                       "1850","1860","1870","1880","1890","1900","1910","1920","1930","1940",
                       "1950","1960","1970","1980","1990","2000","2010","2020","2030")

#Now test CSss by decade
summary(glmer(CSss~decade+(1|phylum_class),data=surveymorpho,family=binomial))

#and by year
summary(glmer(CSss~yearb+(1|phylum_class),data=surveymorpho,family=binomial))


```
So no effect of time on CSss, either by year (continuous) or decade (bins).

3. Are there differences in the number that are easy or hard to access through time?
First, test trend in HARD to access through time:

```{r}
surveyaccess<-filter(survey, HDifAccess != "NA")
surveyaccess$Difficult<-surveyaccess$HDifAccess=="Inaccessible"
surveyaccess$decade<-cut(as.numeric(surveyaccess$yearb),breaks=breaks)
levels(surveymorpho$decade)<-c("1760","1770","1780","1790","1800","1810","1820","1830","1840",
                       "1850","1860","1870","1880","1890","1900","1910","1920","1930","1940",
                       "1950","1960","1970","1980","1990","2000","2010","2020","2030")


summary(glmer(Difficult~yearb+(1|phylum_class),data=surveyaccess,family=binomial))

```

So there IS a trend where Difficult Access CS are described later. How about easy?
```{r}
surveyaccess$Easy<-surveyaccess$HDifAccess=="Accessible"

summary(glmer(Easy~yearb+(1|phylum_class),data=surveyaccess,family=binomial))

```

...and where easy ones are described earlier.

4. How about HKK (habitat connectivity) and an association with CSss? 

```{r}
summary(glmer(CSss~HKKv3+(1|phylum_class),data=surveymorpho,family=binomial))

```

Slight effect of HKKv3, with a positive effect (large HKK more likely to show more CSss).

5. Is habitat stability associated with CSss?

```{r}
Hstable<-c()

for (i in 1:length(surveymorpho$NameBeforeCor)) {
  if (is.na(surveymorpho$Hcoralreef[i]))
    b<-"NA"
  else if (surveymorpho$Hpelagic[i] == TRUE)
    b<-"TRUE"
  else if (surveymorpho$Hdeepsea[i] == TRUE)
    b<-"TRUE"
  else if (surveymorpho$Hcave[i] == TRUE)
    b<-"TRUE"
  #else if (surveymorpho$Hcoralreef[i]  == TRUE)
    #b<-"TRUE"
    else
    b<-"FALSE"
  
  Hstable<-c(Hstable,b)
  
}

surveymorpho<-cbind(surveymorpho,Hstable)

summary(glmer(CSss~Hstable+(1|phylum_class),data=surveymorpho,family=binomial))

summary(glmer(CSss~Hstable+HKKv3+(1|phylum_class),data=surveymorpho,family=binomial))



```
No effect of habitat stability with these habitat classes. <- Note April 4 -- NOW THAT I HAVE MADE CORAL NOT STABLE, THIS IS NOT TRUE. MORE CSSS IN STABLE HABITATS.

6. Are CSss more common in sympatry or not?
```{r}
summary(glmer(CSss~Sympatric+(1|phylum_class),data=surveymorpho,family=binomial))

```
CSss are LESS common in sympatry, which matches predictions (sympatric species have diagnostic diffs). 

7. Are species in sympatry more likely to have ecological differentiation?
```{r}
summary(glmer(Eco_diff~Sympatric+(1|phylum_class),data=survey,family=binomial))

```
No, no relation

8. Are CSss more likely in species with eco diff?
```{r}
summary(glmer(CSss~Eco_diff+(1|phylum_class),data=surveymorpho,family=binomial))

```

Species with ecological differentiation are LESS likely to be CSss (more likely to have diagnostic differences).

9. Biological traits associated with CSss?
```{r}
summary(glmer(CSss~hard_skeleton+(1|phylum_class),data=surveymorpho,family=binomial))
summary(glmer(CSss~ferti+(1|phylum_class),data=surveymorpho,family=binomial))
summary(glmer(CSss~genitals+(1|phylum_class),data=surveymorpho,family=binomial))
summary(glmer(CSss~image+(1|phylum_class),data=surveymorpho,family=binomial))

```

10. Ok, now larvae.
```{r}
surveylarvmorpho<-filter(surveylarv, Morpho_diff != "NA")
surveylarvmorpho<-filter(surveylarvmorpho, Larv_type != "NA")#make matrix where only the cases where morpho was studied is here
summary(glmer(CSss~Repro_invest+(1|phylum_class),data=surveylarvmorpho,family=binomial))
summary(glmer(CSss~Larv_type+(1|phylum_class),data=surveylarvmorpho,family=binomial))


```
No effect of larval type (3 categories) or reproductive investment (2 categories).

11. Sediment vs rocky only
```{r}
surveysed<-filter(surveymorpho, Hsubstrate != "NA") #make matrix where only the cases for rocky or sediment habitat
surveysed<-filter(surveysed, Hsubstrate != "Sediment and Rocky") #and remove the cases with both

summary(glmer(CSss~Hsubstrate+(1|phylum_class),data=surveysed,family=binomial))

```
Significant! More likely to have CSss in sediment than on rocky shores.

# Now let's make some graphs
Fig 1: ss vs sl by major class. I want this to be a barplot with Proportion CSss on the y and major classes on the x, with a horizontal dashed line for the overall proportion.

```{r}
#First, reduce the dataset to only large classes
largeclass<-c()
class_string<-c("Mollusca_Gastropoda",
"Arthropoda_Malacostraca",
"Chordata_Actinopterygii",
"Annelida_Polychaeta",
"Cnidaria_Anthozoa",
"Arthropoda_Hexanauplia",
"Mollusca_Bivalvia",
"Cnidaria_Scyphozoa",
"Porifera_Demospongiae",
"Cnidaria_Hydrozoa",
"Chordata_Ascidiacea",
"Echinodermata_Asteroidea",
"Nemertea_Hoplonemertea")
  
for (i in 1:length(surveymorpho$NameBeforeCor)) {
  if (surveymorpho$phylum_class[i]%in% class_string == TRUE)
    b<-TRUE
      else 
      b<-NA

  largeclass<-rbind(largeclass,b)

}

largeclasstable<-as.data.frame(cbind(surveymorpho,largeclass))
largeclasstable<-largeclasstable[!is.na(largeclasstable$largeclass),]

#Now, we need the proportion of CSss in each large class

classtable<-table(largeclasstable$phylum_class,largeclasstable$CSss)
percent_ss<-c()

for (i in 1:length(classtable[,2])) {
  b<-(classtable[i,2]/(classtable[i,1]+classtable[i,2]))
  percent_ss<-rbind(percent_ss,b)
}

classtable<-as.data.frame(cbind(rownames(classtable),classtable,percent_ss))
colnames(classtable)<-c("Class","SL","SS","Percent_SS")

ggplot(classtable,aes(x=Class,y=as.numeric(Percent_SS)))+
  geom_bar(stat="identity")+
  geom_hline(yintercept=0.659,linetype=2)+
  ylab("Proportion CS sensu stricto")+
  xlab("Phylum and Class")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())+
    annotate("text", x = 1, y = 0.1, label = "48", size = 4.5,color="white")+
  annotate("text", x = 2, y = 0.1, label = "18", size = 4.5,color="white")+
  annotate("text", x = 3, y = 0.1, label = "73", size = 4.5,color="white")+
  annotate("text", x = 4, y = 0.1, label = "64", size = 4.5,color="white")+
  annotate("text", x = 5, y = 0.1, label = "11", size = 4.5,color="white")+
  annotate("text", x = 6, y = 0.1, label = "27", size = 4.5,color="white")+
  annotate("text", x = 7, y = 0.1, label = "13", size = 4.5,color="white")+
  annotate("text", x = 8, y = 0.1, label = "14", size = 4.5,color="white")+
  annotate("text", x = 9, y = 0.1, label = "10", size = 4.5,color="white")+
  annotate("text", x = 10, y = 0.1, label = "15", size = 4.5,color="white")+
  annotate("text", x = 11, y = 0.1, label = "77", size = 4.5,color="white")+
  annotate("text", x = 12, y = 0.1, label = "11", size = 4.5,color="white")+
  annotate("text", x = 13, y = 0.1, label = "14", size = 4.5,color="white")
 

```

Fig 2: CS through time, with habitat access plotted over. NEED TO THINK THROUGH

```{r}

ggplot(surveyaccess,aes(x=yearb,y=HDifAccess))+
  geom_boxplot()+
  geom_jitter(alpha=0.8)+
   ylab("Difficulty of Habitat Access")+
  xlab("Year Described")+
  theme_bw()+ 
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())


```

Fig 3: HKK and proportion CSss. This will be a bar graph with the 6 HKK values on the x, proportion ss on the y.

```{r}
Hkk_count<-table(surveymorpho$HKKv3,surveymorpho$CSss)
percent_ss<-c()

for (i in 1:length(Hkk_count[,2])) {
  b<-(Hkk_count[i,2]/(Hkk_count[i,1]+Hkk_count[i,2]))
  percent_ss<-rbind(percent_ss,b)
}

Hkk_count<-as.data.frame(cbind(rownames(Hkk_count),Hkk_count,percent_ss))
colnames(Hkk_count)<-c("HKK","SL","SS","Percent_SS")

Hkk_count["HKK"][Hkk_count["HKK"] == "1"] <- "A1"
Hkk_count["HKK"][Hkk_count["HKK"] == "5"] <- "B5"
Hkk_count["HKK"][Hkk_count["HKK"] == "10"] <- "C10"
Hkk_count["HKK"][Hkk_count["HKK"] == "25"] <- "D25"
Hkk_count["HKK"][Hkk_count["HKK"] == "100"] <- "E100"
Hkk_count["HKK"][Hkk_count["HKK"] == "1000"] <- "F1000"

cats2<-ggplot(Hkk_count,aes(x=HKK,y=as.numeric(Percent_SS)))+
  geom_bar(stat="identity")+
  #geom_hline(yintercept=0.659,linetype=2)+
  ylab("Proportion CS sensu stricto")+
  xlab("Connectivity")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))


#Ok, now need a panel that does this but with the three morpho classes.
#Code taken from Oct11 file

Hkk_count3<-table(surveymorpho$HKKv3)
morphodiff<-table(surveymorpho$Morpho_diff,surveymorpho$HKKv3) 
stat_diag<-morphodiff[3,]/morphodiff[1,]
stat_anydiff<-morphodiff[3,]/(morphodiff[3,]+morphodiff[1,])
stat_total<-morphodiff[3,]/Hkk_count3
diag_total<-morphodiff[1,]/Hkk_count3
nod_total<-morphodiff[2,]/Hkk_count3
HKKtable<-rbind(stat_total,diag_total,nod_total)
morphodiff 
HKKtable
Hkk_count3

#Graph
HKKtable2<-pivot_longer(as.data.frame(HKKtable), cols=1:6, names_to = "HKK",
                        values_to = "Percent", values_drop_na = FALSE)
HKKtable2$Diff_type<-c("Statistical","Statistical","Statistical","Statistical","Statistical","Statistical","Pseudo-CS","Pseudo-CS","Pseudo-CS","Pseudo-CS","Pseudo-CS","Pseudo-CS","Undifferentiated","Undifferentiated","Undifferentiated","Undifferentiated","Undifferentiated","Undifferentiated")
HKKtable2["HKK"][HKKtable2["HKK"] == "1"] <- "A1"
HKKtable2["HKK"][HKKtable2["HKK"] == "5"] <- "B5"
HKKtable2["HKK"][HKKtable2["HKK"] == "10"] <- "C10"
HKKtable2["HKK"][HKKtable2["HKK"] == "25"] <- "D25"
HKKtable2["HKK"][HKKtable2["HKK"] == "100"] <- "E100"
HKKtable2["HKK"][HKKtable2["HKK"] == "1000"] <- "F1000"

palwes<-c("#F21A00","#EBCC2A","#3B9AB2")


ggplot(as.data.frame(HKKtable2),aes(x=HKK,y=Percent,fill=Diff_type,))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=palwes)+
  xlab("Connectivity")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))+
  annotate("text", x = 1, y = 0.1, label = "1", size = 4.5,color="white")+
  annotate("text", x = 2, y = 0.1, label = "20", size = 4.5,color="white")+
  annotate("text", x = 3, y = 0.1, label = "34", size = 4.5,color="white")+
  annotate("text", x = 4, y = 0.1, label = "37", size = 4.5,color="white")+
  annotate("text", x = 5, y = 0.1, label = "22", size = 4.5,color="white")+
  annotate("text", x = 6, y = 0.1, label = "11", size = 4.5,color="white")+
  annotate("text", x = 1, y = 0.9, label = "4", size = 4.5,color="white")+
  annotate("text", x = 2, y = 0.9, label = "37", size = 4.5,color="white")+
  annotate("text", x = 3, y = 0.9, label = "49", size = 4.5,color="white")+
  annotate("text", x = 4, y = 0.9, label = "49", size = 4.5,color="white")+
  annotate("text", x = 5, y = 0.9, label = "9", size = 4.5,color="white")+
  annotate("text", x = 6, y = 0.9, label = "11", size = 4.5,color="white")+
  annotate("text", x = 2, y = 0.4, label = "33", size = 4.5)+
  annotate("text", x = 3, y = 0.45, label = "57", size = 4.5)+
  annotate("text", x = 4, y = 0.45, label = "33", size = 4.5)+
  annotate("text", x = 5, y = 0.65, label = "13", size = 4.5)+
  annotate("text", x = 6, y = 0.5, label = "52", size = 4.5)+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())


#plot_grid(cats2,cats3,labels=c("A","B"),ncol=1)


```

Fig 4: Sympatry vs morpho and eco diffs. This will be a two-panel with Proportion ss on the y, and on the x will be morpho diffs OR eco diffs (two panels).

```{r}
#for sympatry
Morphodiffs<-table(surveymorpho$CSss,surveymorpho$Sympatric)
Morphodiffstable<-pivot_longer(as.data.frame(Morphodiffs),cols=1)
colnames(Morphodiffstable)<-c("Sympatric","Freq","name","CSss")

percentCSss<-c((Morphodiffstable[2,2]/(Morphodiffstable[1,2]+Morphodiffstable[2,2])),(Morphodiffstable[4,2]/(Morphodiffstable[3,2]+Morphodiffstable[4,2])))
Morphodiffsgraphtable<-as.data.frame(cbind(as.numeric(percentCSss),c("No","Yes")))
colnames(Morphodiffsgraphtable)<-c("percentCSss","Sympatry")

Sympatrygraph<-ggplot(Morphodiffsgraphtable,aes(x=Sympatry,y=as.numeric(percentCSss)))+
  geom_bar(stat="identity")+
  #geom_hline(yintercept=0.659,linetype=2)+
  ylab("CS sensu stricto")+
  xlab("Sympatry")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text.y= element_text(size=10))+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())

#for Ecodiffs
Ecodiffs<-table(survey$Eco_diff,survey$Sympatric)[1:2,]
Ecodiffstable<-pivot_longer(as.data.frame(Ecodiffs),cols=1)
colnames(Ecodiffstable)<-c("Sympatric","Freq","name","Eco_diff")

percentEcodiff<-c((Ecodiffstable[2,2]/(Ecodiffstable[1,2]+Ecodiffstable[2,2])),(Ecodiffstable[4,2]/(Ecodiffstable[3,2]+Ecodiffstable[4,2])))
Ecodiffsgraphtable<-as.data.frame(cbind(as.numeric(percentEcodiff),c("No","Yes")))
colnames(Ecodiffsgraphtable)<-c("percentEcodiff","Sympatry")

Ecograph<-ggplot(Ecodiffsgraphtable,aes(x=Sympatry,y=as.numeric(percentEcodiff)))+
  geom_bar(stat="identity")+
  #geom_hline(yintercept=0.659,linetype=2)+
  ylab("Ecologically Differentiated")+
  xlab("Sympatry")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text.y= element_text(size=10))+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())
  

plot_grid(Sympatrygraph,Ecograph,ncol=1,labels=c("A","B"))


#Trying mosaic plots March 27

Sympatrygraph2<-ggplot(data = surveymorpho) +
  geom_mosaic(aes(x = product(Sympatric, CSss)), na.rm=TRUE)+
  labs(x ="In Sympatry", y = "Is CSss")+
  theme_bw()+
  theme(legend.title=element_blank())+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())+
  theme(axis.text.x = element_text(angle = 65,hjust=1))+
    annotate("text", x = .15, y = .15, label = "48", size = 4.5,color="white")+
  annotate("text", x = .15, y = .65, label = "142", size = 4.5,color="white")+
  annotate("text", x = .65, y = .65, label = "179", size = 4.5,color="white")+
  annotate("text", x = .65, y = .15, label = "117", size = 4.5,color="white")+
  theme(axis.title.x=element_blank())+
  theme(axis.text.x=element_blank())

surveyeco<-droplevels(surveymorpho,exclude="Yes (sea surface temperature)")

Ecograph2<-ggplot(data = surveyeco) +
  geom_mosaic(aes(x = product(Sympatric, Eco_diff)), na.rm=TRUE)+
  labs(x ="In Sympatry", y = "Ecological Differences")+
  theme_bw()+
  theme(legend.title=element_blank())+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())+
  theme(axis.text.x = element_text(angle = 65,hjust=1))+
    annotate("text", x = .15, y = .15, label = "10", size = 4.5,color="white")+
  annotate("text", x = .15, y = .65, label = "30", size = 4.5,color="white")+
  annotate("text", x = .65, y = .65, label = "86", size = 4.5,color="white")+
  annotate("text", x = .65, y = .15, label = "21", size = 4.5,color="white")

plot_grid(Sympatrygraph2,Ecograph2,ncol=1,labels=c("A","B"))


```

# OK. Break in code and thoughts.
Here we are, March 7, and I'm trying to use AIC to compare different glmers with variables to see which is 'most important.' 

The variables that are significant in one-by-one analysis are sympatry, HKKv3, and sediment vs rocky habitat. We will therefore test this using the subset of species that are either soft sediment or rocky.


```{r}
#This function didn't work well.
anocAIC(glmer(CSss~HKKv3+(1|phylum_class),data=surveysed,family=binomial),glmer(CSss~Sympatric+(1|phylum_class),data=surveysed,family=binomial),glmer(CSss~HKKv3*Sympatric+(1|phylum_class),data=surveysed,family=binomial),digits=2)
```

Next try: need to just run regular models to get AIC/BIC values, then make a table - I'm not going to be able to do the comparison functions (habitat data has zero covariance or something, look at error message if needed)

```{r}
glmer(CSss~HKKv3+(1|phylum_class),data=surveysed,family=binomial)
glmer(CSss~Sympatric+(1|phylum_class),data=surveysed,family=binomial)
glmer(CSss~Hsubstrate+(1|phylum_class),data=surveysed,family=binomial)
glmer(CSss~HKKv3*Sympatric+(1|phylum_class),data=surveysed,family=binomial)
glmer(CSss~HKKv3*Hsubstrate+(1|phylum_class),data=surveysed,family=binomial)
glmer(CSss~Hsubstrate*Sympatric+(1|phylum_class),data=surveysed,family=binomial)
glmer(CSss~Hsubstrate*Sympatric*HKKv3+(1|phylum_class),data=surveysed,family=binomial)

```

# Here again March 13 to test whether zones are related to CSss.

```{r}
spolmorpho<-filter(surveymorpho, Spol != "NA") #make matrix where only the cases where morpho was studied is here

summary(glmer(CSss~Spol+(1|phylum_class),data=spolmorpho,family=binomial))

```
# No significant results. 

# Consider only shallow species, sediment vs rocky (206 cases)

```{r}
shallow<-read.csv("shallow_rock_sed.csv",header=T)
shallow<-filter(shallow, Hsubstrate != "Sediment and Rocky") #and remove the cases with both, 193 cases remaining

summary(glmer(CSss~Hsubstrate+(1|phylum_class),data=shallow,family=binomial))

```

#Need something about zones?

```{r}
tropmorpho<-filter(surveymorpho, Trop != "NA") #make matrix where only the cases where morpho was studied is here
summary(glmer(CSss~Trop+(1|phylum_class),data=tropmorpho,family=binomial))

npolmorpho<-filter(surveymorpho, Npol != "NA") #make matrix where only the cases where morpho was studied is here
summary(glmer(CSss~Npol+(1|phylum_class),data=npolmorpho,family=binomial))

ntempmorpho<-filter(surveymorpho, Ntemp != "NA") #make matrix where only the cases where morpho was studied is here
summary(glmer(CSss~Ntemp+(1|phylum_class),data=ntempmorpho,family=binomial))

spolmorpho<-filter(surveymorpho, Spol != "NA") #make matrix where only the cases where morpho was studied is here
summary(glmer(CSss~Spol+(1|phylum_class),data=spolmorpho,family=binomial))

stempmorpho<-filter(surveymorpho, Stemp != "NA") #make matrix where only the cases where morpho was studied is here
summary(glmer(CSss~Stemp+(1|phylum_class),data=stempmorpho,family=binomial))

```


## Graphs on April 12 2024, prepping for Montpellier seminar

First, a graph looking at the shallow rocky vs sediment habitat
```{r}
Shallowdiffs<-table(shallow$CSss,shallow$Hsubstrate)
Shallowdiffstable<-pivot_longer(as.data.frame(Shallowdiffs),cols=1)
colnames(Shallowdiffstable)<-c("Substrate","Freq","name","CSss")


percentShallowdiff<-c((Shallowdiffstable[2,2]/(Shallowdiffstable[1,2]+Shallowdiffstable[2,2])),(Shallowdiffstable[4,2]/(Shallowdiffstable[3,2]+Shallowdiffstable[4,2])))
Shallowdiffsgraphtable<-as.data.frame(cbind(as.numeric(percentShallowdiff),c("Rocky","Sediment")))
colnames(Shallowdiffsgraphtable)<-c("percentCSss","Substrate")


ggplot(Shallowdiffsgraphtable,aes(x=Substrate,y=as.numeric(percentCSss)))+
  geom_bar(stat="identity")+
  ylab("Proportion CS sensu stricto")+
  xlab("Substrate")+
  ylim(0,1)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())
```

Now let's do this for stable habitats overall.

```{r}
stablediffs<-table(surveymorpho$CSss,surveymorpho$Hstable)
stablediffstable<-pivot_longer(as.data.frame(stablediffs),cols=1)
colnames(stablediffstable)<-c("Stable","Freq","name","CSss")


percentstablediff<-c((stablediffstable[2,2]/(stablediffstable[1,2]+stablediffstable[2,2])),(stablediffstable[4,2]/(stablediffstable[3,2]+stablediffstable[4,2])))
stablediffsgraphtable<-as.data.frame(cbind(as.numeric(percentstablediff),c("Not_Stable","Stable")))
colnames(stablediffsgraphtable)<-c("percentCSss","Habitat")


ggplot(stablediffsgraphtable,aes(x=Habitat,y=as.numeric(percentCSss)))+
  geom_bar(stat="identity")+
  ylab("Proportion CS sensu stricto")+
  xlab("Habitat")+
  ylim(0,1)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())
```

Need graph of the biological factors

```{r}
skel<-ggplot(data = surveymorpho) +
  geom_mosaic(aes(x = product(CSss,hard_skeleton), fill=CSss), na.rm=TRUE)+
  labs(x ="Hard Skeleton", y = "Is CSss")+
  theme_bw()+
  theme(legend.title=element_blank())+
   theme(legend.position="none")+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())+
  theme(axis.text.x = element_text(angle = 65,hjust=1))

vision<-ggplot(data = surveymorpho) +
  geom_mosaic(aes(x = product(CSss,image), fill=CSss), na.rm=TRUE)+
  labs(x ="Image Vision", y = "Is CSss")+
  theme_bw()+
  theme(legend.title=element_blank())+
     theme(legend.position="none")+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())+
  theme(axis.text.x = element_text(angle = 65,hjust=1))

genitals<-ggplot(data = surveymorpho) +
  geom_mosaic(aes(x = product(CSss,genitals), fill=CSss), na.rm=TRUE)+
  labs(x ="External Genitals", y = "Is CSss")+
  theme_bw()+
  theme(legend.title=element_blank())+
     theme(legend.position="none")+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())+
  theme(axis.text.x = element_text(angle = 65,hjust=1))

fertitype<-ggplot(data = surveymorpho) +
  geom_mosaic(aes(x = product(CSss,ferti), fill=CSss), na.rm=TRUE)+
  labs(x ="Fertilization Type", y = "Is CSss")+
  theme_bw()+
  theme(legend.title=element_blank())+
     theme(legend.position="none")+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())+
  theme(axis.text.x = element_text(angle = 65,hjust=1))

plot_grid(skel,vision,genitals,fertitype,ncol=2)
```

# Trying again April 24 with some new ideas.

What if I build a model wtih lots of variables just inside one class?

```{r}
gastro<-filter(surveymorpho, phylum_class == "Mollusca_Gastropoda")
summary(glm(CSss~gastro$Hsubstrate,data=gastro,family=binomial))
summary(glm(CSss~Hsubstrate*HKKv3,data=gastro,family=binomial))


arthro<-filter(surveymorpho, phylum_class == "Arthropoda_Malacostraca")
summary(glm(CSss~arthro$Hsubstrate,data=arthro,family=binomial))

fish<-filter(surveymorpho, phylum_class == "Chordata_Actinopterygii")
summary(glm(CSss~fish$Hsubstrate,data=fish,family=binomial))

```

I think sample sizes may be too small. 

Attempt at model selection with whole dataset
```{r}
mat<-select(surveymorpho, c(HKKv3, phylum_class, Sympatric,yearb,hard_skeleton,ferti,image,genitals, CSss))
mat[1:9]<-lapply(mat[1:9],as.factor)
outBIC<-bestglm(mat,IC="BIC", family=binomial,TopModels=10)  
outBIC$BestModels 

outAIC<-bestglm(mat,IC="AIC", family=binomial,TopModels=10)  
outAIC$BestModels 

```

Attempt at model selection with gastro only
```{r}
mat<-select(gastro, c(HKKv3, Sympatric,yearb,CSss))
mat[1:4]<-lapply(mat[1:4],as.factor)
outBIC<-bestglm(mat,IC="BIC", family=binomial,TopModels=10,nvmax=1)  
outBIC$BestModels 

outAIC<-bestglm(mat,IC="AIC", family=binomial,TopModels=10,nvmax=1)  
outAIC$BestModels 

gastro2<-filter(gastro, Hsubstrate != "NA")
mat<-select(gastro2, c(Trop,Ntemp,Npol,Stemp,Hsubstrate,HKKv3, Sympatric,yearb,CSss))
mat[1:9]<-lapply(mat[1:9],as.factor)
outBIC<-bestglm(mat,IC="BIC", family=binomial,TopModels=10,nvmax=1)  
outBIC$BestModels 
```

But there are a lot of missing values on Hsubstrate, so let's try with the smaller surveysed set.
```{r}
mat<-select(surveysed, c(Hsubstrate, HKKv3, phylum_class, Sympatric, yearb,hard_skeleton,ferti,image,genitals, CSss))
mat[1:10]<-lapply(mat[1:10],as.factor)
outBIC<-bestglm(mat,IC="BIC", family=binomial,TopModels=10)  
outBIC$BestModels 

outAIC<-bestglm(mat,IC="AIC", family=binomial,TopModels=10)  
outAIC$BestModels 
```

And what about the shallow-water sediment vs rocky set?
```{r}
mat<-select(shallow, c(Hsubstrate, HKKv3, phylum_class, Sympatric, yearb,hard_skeleton,ferti,image,genitals, CSss))
mat[1:10]<-lapply(mat[1:10],as.factor)
outBIC<-bestglm(mat,IC="BIC", family=binomial,TopModels=10)  
outBIC$BestModels 

outAIC<-bestglm(mat,IC="AIC", family=binomial,TopModels=10)  
outAIC$BestModels 

```

# April 25 2024 -- work to run separate analyses for rocky shores and hard sediment.

1. Split the data into a sediment set AND a rocky set for HKK analyses.
```{r}
surveymorpho<-filter(survey, Morpho_diff != "NA") #make matrix where only the cases where morpho was studied is here

sediment<-filter(surveymorpho, Hsubstrate == "Sediment") #only sediment cases
summary(glmer(CSss~HKKv3+(1|phylum_class),data=sediment,family=binomial))

rocky<-filter(surveymorpho, Hsubstrate == "Rocky") #only rocky cases
summary(glmer(CSss~HKKv3+(1|phylum_class),data=rocky,family=binomial))

rockybis<-filter(rocky,HKKv3 !=1)
rockybis<-filter(rockybis,HKKv3 !=1000) #removing extreme cases because n=1 for both

#making graphs
Hkk_countsed<-table(sediment$HKKv3)
morphodiffsed<-table(sediment$Morpho_diff,sediment$HKKv3) 
stat_diag<-morphodiffsed[3,]/morphodiffsed[1,]
stat_anydiff<-morphodiffsed[3,]/(morphodiffsed[3,]+morphodiffsed[1,])
stat_total<-morphodiffsed[3,]/Hkk_countsed
diag_total<-morphodiffsed[1,]/Hkk_countsed
nod_total<-morphodiffsed[2,]/Hkk_countsed
HKKtablesed<-rbind(stat_total,diag_total,nod_total)
morphodiffsed 
HKKtablesed
Hkk_countsed

HKKtable2sed<-pivot_longer(as.data.frame(HKKtablesed), cols=1:4, names_to = "HKK",
                        values_to = "Percent", values_drop_na = FALSE)
HKKtable2sed$Diff_type<-c("Statistical","Statistical","Statistical","Statistical","Pseudo-CS","Pseudo-CS","Pseudo-CS","Pseudo-CS","Undifferentiated","Undifferentiated","Undifferentiated","Undifferentiated")
HKKtable2sed["HKK"][HKKtable2sed["HKK"] == "5"] <- "B5"
HKKtable2sed["HKK"][HKKtable2sed["HKK"] == "10"] <- "C10"
HKKtable2sed["HKK"][HKKtable2sed["HKK"] == "25"] <- "D25"
HKKtable2sed["HKK"][HKKtable2sed["HKK"] == "100"] <- "E100"


palwes<-c("#F21A00","#EBCC2A","#3B9AB2")


sedplot<-ggplot(as.data.frame(HKKtable2sed),aes(x=HKK,y=Percent,fill=Diff_type,))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=palwes)+
  xlab("Connectivity")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))+ 
  annotate("text", x = 1, y = 0.05, label = "6", size = 4.5,color="white")+
  annotate("text", x = 2, y = 0.05, label = "2", size = 4.5,color="white")+
  annotate("text", x = 3, y = 0.05, label = "21", size = 4.5,color="white")+
  annotate("text", x = 4, y = 0.05, label = "13", size = 4.5,color="white")+
  annotate("text", x = 1, y = 0.95, label = "8", size = 4.5,color="white")+
  annotate("text", x = 2, y = 0.95, label = "6", size = 4.5,color="white")+
  annotate("text", x = 3, y = 0.95, label = "9", size = 4.5,color="white")+
  annotate("text", x = 4, y = 0.95, label = "2", size = 4.5,color="white")+
  annotate("text", x = 1, y = 0.45, label = "9", size = 4.5)+
  annotate("text", x = 2, y = 0.45, label = "13", size = 4.5)+
  annotate("text", x = 3, y = 0.6, label = "10", size = 4.5)+
  annotate("text", x = 4, y = 0.8, label = "4", size = 4.5)+
   theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())


Hkk_countrocky<-table(rockybis$HKKv3)
morphodiffrocky<-table(rockybis$Morpho_diff,rockybis$HKKv3) 
stat_diag<-morphodiffrocky[3,]/morphodiffrocky[1,]
stat_anydiff<-morphodiffrocky[3,]/(morphodiffrocky[3,]+morphodiffrocky[1,])
stat_total<-morphodiffrocky[3,]/Hkk_countrocky
diag_total<-morphodiffrocky[1,]/Hkk_countrocky
nod_total<-morphodiffrocky[2,]/Hkk_countrocky
HKKtablerocky<-rbind(stat_total,diag_total,nod_total)
morphodiffrocky 
HKKtablerocky
Hkk_countrocky

HKKtable2rocky<-pivot_longer(as.data.frame(HKKtablerocky), cols=1:4, names_to = "HKK",
                        values_to = "Percent", values_drop_na = FALSE)
HKKtable2rocky$Diff_type<-c("Statistical","Statistical","Statistical","Statistical","Pseudo-CS","Pseudo-CS","Pseudo-CS","Pseudo-CS","Undifferentiated","Undifferentiated","Undifferentiated","Undifferentiated")
HKKtable2rocky["HKK"][HKKtable2rocky["HKK"] == "5"] <- "B5"
HKKtable2rocky["HKK"][HKKtable2rocky["HKK"] == "10"] <- "C10"
HKKtable2rocky["HKK"][HKKtable2rocky["HKK"] == "25"] <- "D25"
HKKtable2rocky["HKK"][HKKtable2rocky["HKK"] == "100"] <- "E100"


rockyplot<-ggplot(as.data.frame(HKKtable2rocky),aes(x=HKK,y=Percent,fill=Diff_type,))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=palwes)+
  xlab("Connectivity")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))+
  annotate("text", x = 1, y = 0.05, label = "6", size = 4.5,color="white")+
  annotate("text", x = 2, y = 0.05, label = "4", size = 4.5,color="white")+
  annotate("text", x = 3, y = 0.05, label = "6", size = 4.5,color="white")+
  annotate("text", x = 4, y = 0.25, label = "1", size = 4.5,color="white")+
  annotate("text", x = 1, y = 0.95, label = "21", size = 4.5,color="white")+
  annotate("text", x = 2, y = 0.95, label = "4", size = 4.5,color="white")+
  annotate("text", x = 3, y = 0.95, label = "18", size = 4.5,color="white")+
  annotate("text", x = 1, y = 0.4, label = "16", size = 4.5)+
  annotate("text", x = 2, y = 0.4, label = "9", size = 4.5)+
  annotate("text", x = 3, y = 0.4, label = "10", size = 4.5)+
  annotate("text", x = 4, y = 0.75, label = "1", size = 4.5)+
  theme(panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_blank())

plot_grid(sedplot,rockyplot,ncol=1,labels=c("A","B"))
```

Ok, now let's test the larvae within the habitat.

```{r}
surveylarvmorpho<-filter(surveylarv, Morpho_diff != "NA")
surveylarvmorpho<-filter(surveylarvmorpho, Larv_type != "NA")

#now sediment and larvae (n=70)
sedimentlarv<-filter(surveylarvmorpho, Hsubstrate == "Sediment") 
summary(glmer(CSss~HKKv3+(1|phylum_class),data=sedimentlarv,family=binomial)) 

#and rocky and larvae (n=68)
rockylarv<-filter(surveylarvmorpho, Hsubstrate == "Rocky") 
summary(glmer(CSss~HKKv3+(1|phylum_class),data=rockylarv,family=binomial)) 
```

Ok, now building a glm of the factors that have been significant in univariate analysis, and selecting bestglm.

First with all data
```{r}
mat<-select(surveymorpho, c(HKKv3, phylum_class, Sympatric,CSss))
mat[1:4]<-lapply(mat[1:4],as.factor)
outBIC<-bestglm(mat,IC="BIC", family=binomial,TopModels=10)  
outBIC$BestModels 

outAIC<-bestglm(mat,IC="AIC", family=binomial,TopModels=10)  
outAIC$BestModels 
```

And now with the shallow-water rocky vs soft sed dataset
```{r}
shallow<-read.csv("shallow_rock_sed.csv",header=T)
shallow<-filter(shallow, Hsubstrate != "Sediment and Rocky") #and remove the cases 

mat<-select(shallow, c(Hsubstrate, HKKv3, phylum_class, Sympatric, CSss))
mat[1:5]<-lapply(mat[1:5],as.factor)
outBIC<-bestglm(mat,IC="BIC", family=binomial,TopModels=10)  
outBIC$BestModels 

outAIC<-bestglm(mat,IC="AIC", family=binomial,TopModels=10)  
outAIC$BestModels 
```

