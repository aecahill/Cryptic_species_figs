---
title: "CS_invasive"
output: html_document
date: "2024-06-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## CS and invasive species overlap

Trying to figure out the overlap between our CS database and other databases of invasive species

First, read in files

```{r}
library(dplyr)
library(stringr)
library(ggplot2)
library(tidyr)
library(cowplot)
library(wesanderson)


survey <- read.csv(file="978_species_clean_may17.csv"   , header=TRUE ) #Adjusted Nov 15 2023 to fix errors in duplicated species

# Load the WoRMS database (Not sure I need this???)
# This version, for whatever reason, is ONLY ANIMAL SPECIES (from Anne)
# That is fine; it's what I want anyway
worms <- read.csv('taxon.csv',header=TRUE) 

wrims<-read.csv(file="WRIMS_taxon.csv"   , header=TRUE )

#Now filter to only animal species
wrims<-filter(wrims,(kingdom=="Animalia" & taxonRank=="Species")) 
# 2716 species remaining


```
Next, take the species names, compare them, and put into a separate database

```{r}

overlap<- c() # blank dataframe

matchlist<-wrims$acceptedNameUsage %in% survey$acceptedName_wormsV1  #make vector of cases in wrims that have a match in the CS survey

#now this loop take the values for which there is a match and extracts them from the wrims set to make a dataframe
for (i in 1:length(matchlist)){
  if (matchlist[i] == TRUE)
    overlap<-rbind(overlap,wrims[i,])
}

write.csv(overlap,"invasive_CS.csv")

write.csv(table(overlap$class),"invasiveCS_class.csv")
write.csv(table(survey$class_wormsV1),"CS_class.csv")
write.csv(table(wrims$class),"invasive_class.csv")

```

Next step - heat map comparing the relative prevalence in the databases?

```{r}
overlapdata<-read.csv("C:/Users/aecsk/Documents/GitHub/Cryptic_species_figs/overlap_heatmap.csv",header=T)
overlaplarge<-read.csv("C:/Users/aecsk/Documents/GitHub/Cryptic_species_figs/heatmap_overlap_largeclasses.csv",header=T)

  ggplot(data = overlaplarge, mapping = aes(x = Dataset,
                                                 y = Class,
                                                 fill = zscore)) +
    geom_tile() +
    scale_fill_gradient2(low = 'blue', mid = 'white', high = 'red')+
    theme_bw()+
    theme(axis.title.x = element_blank(), 
          axis.title.y = element_blank(), 
          panel.background = element_blank(), 
          panel.grid.major = element_blank(),  
          panel.grid.minor = element_blank(),  
          plot.background = element_blank())
    #theme(legend.position="none") +
    #theme(axis.text.x=element_blank(),axis.text.y=element_blank())
    #facet_grid(~Dataset)

```

Let's check to see how many of the WRIMS species have ncbi data
```{r}
nomsp<-read.csv("DATASET_187603_NominalSpecies.csv",sep=";",header=TRUE)

ncbi_all<-filter(nomsp, ncbi == TRUE) # 38153 spp with NCBI data
  
matchlistncbi<-wrims$acceptedNameUsage %in% ncbi_all$acceptedNameUsage  #make vector of cases in wrims that have a match in the NCBI database
# this is 1610 out of 2716 total

wrimsncbi<-c()
#now this loop take the values for which there is a match and extracts them from the wrims set to make a dataframe
for (i in 1:length(matchlistncbi)){
  if (matchlistncbi[i] == TRUE)
    wrimsncbi<-rbind(wrimsncbi,wrims[i,])
}

overlapncbi<- c() # blank dataframe

matchlist4<-wrimsncbi$acceptedNameUsage %in% survey$acceptedName_wormsV1  #make vector of cases in wrims that have a match in the CS survey

#now this loop take the values for which there is a match and extracts them from the wrims set to make a dataframe
for (i in 1:length(matchlist4)){
  if (matchlist4[i] == TRUE)
    overlapncbi<-rbind(overlapncbi,wrimsncbi[i,])
}



```

```{r}
overlaptry<-read.table("overlaptry2.txt",header=TRUE)
ggplot(data = overlaptry, mapping = aes(x = proportionCS,
                                                 y = proportionWRIMS,
                                                 size = proportionoverlap))+
  geom_point()+
  geom_text(label=overlaptry$Class,nudge_y=0.005)+
  geom_abline(intercept = 0, slope = 1)+
  theme_bw()

ggplot(data = overlaptry, mapping = aes(x = proportionCS,
                                                 y = proportionoverlap))+
  geom_point()+
  geom_text(label=overlaptry$Class,nudge_y=0.005)+
  geom_abline(intercept = 0, slope = 1)+
  theme_bw()

ggplot(data = overlaptry, mapping = aes(x = proportionWRIMS,
                                                 y = proportionoverlap))+
  geom_point()+
  geom_text(label=overlaptry$Class,nudge_y=0.005)+
  geom_abline(intercept = 0, slope = 1)+
  theme_bw()

```

Do the AquaNIS and EASIN databases overlap with WRIMS?

```{r}
wrims<-read.csv(file="WRIMS_taxon.csv", header=TRUE ) #read back in whole database (not just animals), = 7985 species

easin<-read.csv(file="EASIN_database.csv", header=TRUE )
#EASIN is everything in Europe, NOT JUST MARINE, = 14318 species
# ALL taxa (algae, plants, bacteria, etc)

matchlisteasin<-  wrims$acceptedNameUsage %in% easin$Name
# Did it this way because WRIMS is the smaller database
# 1506 species in wrims are found in easin

aquanis<-read.csv(file="AquaNIS_database.csv", header=TRUE )
# AquaNIS is European, marine/coastal freshwater/brackish, = 2261 species
# All taxa, not just animals

matchlistaquanis<- aquanis$Species  %in% wrims$acceptedNameUsage
# 1132 species in AquaNIS found in WRIMS 

nemesis<-read.csv(file="nemesis_species_list.csv", header=TRUE )
# United States database, marine, all taxa, = 657 species

matchlistnemesis<- nemesis$Name  %in% wrims$acceptedNameUsage
# 297 species in Nemesis found in WRIMS
# Looks like 578 animal species, and I expect those would be in WRIMS, so many seem to be missing. Can pull these out.

```

I can't figure out how to filter EASIN and AQUANIS to be only animals / how to get better taxonomic info here. So let's keep working with Nemesis only.

Will create csv with only animals from Nemesis.

```{r}
nemesisanimals<-read.csv(file="nemesis_animals.csv", header=TRUE )

#How many of these are in the survey?
matchlistnemesisCS<- nemesisanimals$Name  %in% survey$acceptedName_wormsV1
sum(matchlistnemesisCS)
#looks like 20 species overlap, or 3.4% of animal list (less than WRIMS total)

#Who are those species?

nemesisCS<-c()
#now this loop take the values for which there is a match and extracts them from the wrims set to make a dataframe
for (i in 1:length(matchlistnemesisCS)){
  if (matchlistnemesisCS[i] == TRUE)
    nemesisCS<-rbind(nemesisCS,nemesisanimals[i,])
}

# I think we again have overrepresentation of polychaetes, bryos, tunicates

# Who is missing from WRIMS given the Nemesis list?
matchlistnemesisanimals<- nemesisanimals$Name  %in% wrims$acceptedNameUsage
# 293 are matches, out of 578 total, so 285 missing!

missingWRIMS<-c()
#now this loop take the values for which there is a match and extracts them from the wrims set to make a dataframe
for (i in 1:length(matchlistnemesisanimals)){
  if (matchlistnemesisanimals[i] == FALSE)
    missingWRIMS<-rbind(missingWRIMS,nemesisanimals[i,])
}

#Now write the file
write.csv(missingWRIMS,"missingWRIMS_from_nemesis.csv")

```

It looks like properly curating the database will be a real chore.
The missing species include
- things wtih "sp." and "sp. A" and "cf", which won't align with WoRMS/WRIMS
- there's some species that WoRMS has labeled as freshwater?
- some unaccepted names? I think Anne had to correct those by hand in the survey sheet.
